package malware_gotchi;
import java.io.File;
import java.io.FileNotFoundException;
import java.util.Scanner;
import java.util.regex.*;
import java.io.FileWriter;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;



public class FileHandler {
	PetData[] dataArray = new PetData[64];
	String fName;

    FileHandler(String source, Scanner sc){
    	fName = source;
	    try{
	    	int i = 0;
	        File petDataFile = new File(fName);
	        Scanner sc1 = new Scanner(petDataFile);

	        while (sc1.hasNextLine()){
	            String data = sc1.nextLine();
	            dataArray[i] = extractData(data);
	            i+=1;
	        }
	        sc1.close();
	        

    
	    }catch (FileNotFoundException e) {
            System.out.println("Error! Could not find a pet data save file!");
            //System.out.println(new File(".").getAbsolutePath());
            System.out.println("Looks like you need a new pet!");
            File petDataFile = new File(source);
            String name = "";
            System.out.println("What would you like to name your new pet?");
            name = sc.nextLine();
            while (!checkName(name)) {
            	name = sc.nextLine(); //Might add more type checking later. No commas or quotes, please!
            	//uppercase, lowercase, and spaces, limit is 20 char
            }
            
           
				Long time = System.currentTimeMillis();
				String l0 = String.join("", "0,petName,String,", name);
				PetData line0 = extractData(l0);
				dataArray[0] = line0;
				String l1 = String.join("", "1,lastFed,String,", time.toString());
				PetData line1 = extractData(l1);
				dataArray[1] =line1;
				PetData line2 = extractData("2,batteries,int,0");
				dataArray[2] = line2;
				PetData line3 = extractData("3,happinessChange,double,0.0");
				dataArray[3] = line3;
				PetData line4 = extractData("4,timesFed,int,0");
				dataArray[4] = line4;
				PetData line5 = extractData("5,gameClassName,AbstractGame,LeftRightGame");
				dataArray[5] = line5;
				
    	        save();

	    }
	}
    
    private boolean checkName(String s) {
    	boolean valid = true;
    	Matcher alphaSpace = Pattern.compile("^[a-zA-Z0-9 ]*$").matcher(s);
    	if (s=="") {
    		valid = false;
    		System.out.println("You have to give your pet a name! Type a name, then press enter.");
    	}
    	else if (alphaSpace.matches()) {
    		valid = false;
    		System.out.println("That's not a good name! Try not using special characters.");
    	}
    	else if (s.length() > 20) {
    		valid = false;
    		System.out.println("That name's too long! It should be shorter than 20 characters.");
    	}
    	
    	
    	
    	return valid;
    }
    
    FileHandler(String source){
    	fName = source;
	    try{
	    	int i = 0;
	        File petDataFile = new File(fName);
	        Scanner sc1 = new Scanner(petDataFile);
	        while (sc1.hasNextLine()){
	            String data = sc1.nextLine();
	            //System.out.println(data);
	            dataArray[i] = extractData(data);
	            i+=1;
	        }
	        sc1.close();

    
	    } catch (FileNotFoundException e) {
            System.out.println("Error! Could not find a pet data save file!");
            System.out.println("This could lead to a crash...");
        }
    }
    
    
    
    private PetData extractData(String line) {
    	String[] data = line.split(",");
    	return new PetData(Integer.valueOf(data[0]),data[1],data[2],data[3]);
    }
    
    private int findIndex(String item) {
    	for(PetData i:dataArray) {if (i!=null) {
    		if (item.equals(i.getVarName())){
    			return i.getIndex();
    		}
    		//System.out.println(i.getVarName());
    	}
    	}
    	return 0;
    }
    
    private void save() {
    	try {
			FileWriter dataFile = new FileWriter("petData.csv");
			for(PetData i : dataArray) {
				if(i!=null) {dataFile.write(i.toString());}
	    	}
			dataFile.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
    }

    public int getBatteries() {
    	int i = findIndex("batteries");
    	return Integer.valueOf(dataArray[i].getData());
    }
    
    public void setBatteries(int data) {
    	int i = findIndex("batteries");
    	dataArray[i].setData(Integer.toString(data));
    	save();
    }
    
    public String getName() {
    	int i = findIndex("petName");
    	return dataArray[i].getData();
    }
    
    public long getLastFed() {
    	int i = findIndex("lastFed");
    	return Long.valueOf(dataArray[i].getData());
    }
    
    public void setLastFed(long data) {
    	int i = findIndex("lastFed");
    	dataArray[i].setData(Long.toString(data));
    	save();
    }
    
    public int getTimesFed() {
    	int i = findIndex("timesFed");
    	return Integer.valueOf(dataArray[i].getData());
    }
    
    public void setTimesFed(int data) {
    	int i = findIndex("timesFed");
    	dataArray[i].setData(Integer.toString(data));
    	save();
    }
    
    public Double getHappinessChange() {
    	int i = findIndex("happinessChange");
    	return Double.valueOf(dataArray[i].getData());
    }
    
    public void setHappinessChange(Double data) {
    	int i = findIndex("happinessChange");
    	dataArray[i].setData(Double.toString(data));
    	save();
    }
    
    public AbstractGame[] getGames() { 
    	String[] gameNamesString = new String[64];
    	int gamesCount = 0;
 
    	for(PetData i:dataArray) {
    		if (i!=null) {
    			if (i.getVarName().equals("gameClassName")){
    				gameNamesString[gamesCount] = i.getData(); 
    				gamesCount ++;
    			}
    		}
    	}
    	AbstractGame[] gamesNames = new AbstractGame[gamesCount];
    	gamesCount = 0;
    	for (String s: gameNamesString) {
    		if (s != null) {
    		Object gameObject;
			try {
				gameObject = Class.forName("malware_gotchi."+ s).getDeclaredConstructor().newInstance();
				AbstractGame gameAbObject = (AbstractGame)gameObject;
				gamesNames[gamesCount] = gameAbObject; 	
			} catch (InstantiationException | IllegalAccessException | IllegalArgumentException
					| InvocationTargetException | NoSuchMethodException | SecurityException
					| ClassNotFoundException e) {
				e.printStackTrace();
			} 
    		}
    	}
    	return gamesNames;
    }
}